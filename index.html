<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="tabTitle">ULKA : CS Dashboard v.0.0.7.7</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
            --primary: #003399;
            --accent: #007aff;
            --text: #1d1d1f;
            --bg-mesh: radial-gradient(at 0% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                       radial-gradient(at 50% 0%, hsla(225,39%,20%,1) 0, transparent 50%), 
                       radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            --danger: #d63031;
            --line: #2ecc71;
            --fb: #3b5998;
        }

        [data-theme="dark"] {
            --glass: rgba(15, 15, 25, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --primary: #64d2ff;
            --accent: #5ac8fa;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-image: var(--bg-mesh);
            background-attachment: fixed;
            margin: 0; padding: 15px;
            color: var(--text);
            min-height: 100vh;
            transition: 0.3s;
        }

        .container { max-width: 1450px; margin: 0 auto; }
        .glass-panel { background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .header h2 { margin: 0; font-size: 18px; color: var(--primary); font-weight: 800; }

        .action-bar { display: flex; align-items: center; gap: 8px; }
        .icon-btn { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: var(--glass); border: 1px solid var(--glass-border); cursor: pointer; font-size: 14px; font-weight: 800; transition: 0.2s; color: var(--text); }
        
        .btn-l.active { background: var(--line); color: #fff; border-color: var(--line); box-shadow: 0 0 10px var(--line); }
        .btn-fb.active { background: var(--fb); color: #fff; border-color: var(--fb); box-shadow: 0 0 10px var(--fb); }

        .search-container { display: flex; align-items: center; background: var(--glass); border-radius: 20px; border: 1px solid var(--glass-border); overflow: hidden; width: 0; transition: width 0.3s ease; }
        .search-container.expanded { width: 140px; padding: 0 10px; }
        .search-container input { border: none; background: transparent; padding: 8px; color: var(--text); outline: none; width: 100%; font-family: 'Sarabun'; font-size: 14px; }

        .refresh-bar-container { width: 100%; height: 4px; background: rgba(0,0,0,0.1); margin-bottom: 15px; border-radius: 10px; overflow: hidden; }
        #refreshBar { width: 0%; height: 100%; background: var(--primary); transition: width 1s linear; }

        .main-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px; }
        @media (min-width: 1000px) { .main-grid { grid-template-columns: 2fr 1.2fr; } }

        .leaderboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        @media (min-width: 600px) { .leaderboard-grid { grid-template-columns: repeat(4, 1fr); } }
        
        .person-card { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 18px; border: 3px solid transparent; transition: 0.3s; color: white; cursor: pointer; }
        .person-card.active-filter { border-color: #fff; box-shadow: 0 0 20px rgba(255,255,255,0.6); transform: translateY(-2px); }
        .card-best { background: #d63031; } .card-friend { background: #0984e3; } .card-ball { background: #e67e22; } .card-ohm { background: #f1c40f; color: #000; }
        .person-name { font-weight: 800; font-size: 16px; text-transform: uppercase; }
        .person-count { font-size: 28px; font-weight: 900; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        @media (min-width: 600px) { .stats-grid { grid-template-columns: repeat(5, 1fr); margin-bottom: 15px; } }
        .stat-card { padding: 12px 5px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .stat-card.active-status { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 122, 255, 0.3); }
        .stat-card h3 { font-size: 11px; margin: 0; opacity: 0.7; font-weight: 600; }
        .stat-card .value { font-size: 24px; font-weight: 800; color: var(--text); margin-top: 5px; }

        .table-wrap { padding: 10px; overflow-x: auto; }
        table { width: 1200px; border-collapse: collapse; } 
        @media (min-width: 1200px) { table { width: 100%; table-layout: fixed; } }
        th { padding: 12px 8px; text-align: left; font-size: 12px; border-bottom: 2px solid var(--glass-border); color: var(--primary); font-weight: 800; }
        td { padding: 12px 8px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: top; }

        .badge { padding: 4px 6px; border-radius: 8px; font-size: 10px; font-weight: 600; color: #fff; text-align: center; display: block; }
        .u-vhigh { background: #ff3b30; } .u-medium { background: #ff9500; } .u-low { background: #007aff; }
        .status-closed { background: #34c759; } .status-process { background: #ffcc00; color: #000; } .status-pending { background: #8e8e93; }

        .btn-add { background: var(--primary); color: #fff; border: none; padding: 10px 20px; border-radius: 14px; font-weight: 700; cursor: pointer; }
        
        /* üìÇ Modern Modal Interface (v.0.0.7.7) */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); z-index: 9999; overflow-y: auto; padding: 20px 0; }
        .modal-content { background: var(--glass); margin: auto; padding: 30px; width: 92%; max-width: 650px; border-radius: 30px; border: 1px solid var(--glass-border); box-shadow: 0 25px 50px rgba(0,0,0,0.4); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; }
        .modal-header h2 { margin: 0; font-size: 22px; color: var(--primary); font-weight: 800; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group.full { grid-column: span 2; }
        
        .modal-content label { font-size: 13px; font-weight: 600; color: var(--text); opacity: 0.9; margin-left: 5px; }
        .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 14px; border-radius: 15px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text); font-family: 'Sarabun'; font-size: 16px; transition: 0.2s; box-sizing: border-box; }
        .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus { outline: none; border-color: var(--primary); background: rgba(255,255,255,0.25); box-shadow: 0 0 0 4px rgba(0,122,255,0.1); }
        
        .submit-btn { background: var(--primary); color: #fff; border: none; padding: 18px; border-radius: 18px; font-weight: 800; font-size: 18px; cursor: pointer; margin-top: 15px; width: 100%; transition: 0.2s; box-shadow: 0 10px 20px rgba(0,122,255,0.3); }
        .submit-btn:active { transform: scale(0.98); opacity: 0.9; }
        .cancel-btn { background: transparent; color: var(--text); border: none; padding: 10px; font-weight: 600; cursor: pointer; width: 100%; opacity: 0.6; margin-top: 5px; }

        #chart_div { width: 100%; height: 220px; }
        .copyable-name { cursor: pointer; color: var(--accent); font-weight: 600; text-decoration: underline dotted; }
        .copy-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 8px 20px; border-radius: 20px; display: none; z-index: 10000; }
    </style>
    <script>
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
    </script>
</head>
<body>

<div class="container">
    <div class="glass-panel header">
        <h2>üìä ULKA : CS Dashboard <span style="font-size:10px; opacity:0.5;">v.0.0.7.7 Alpha</span></h2>
        <div class="action-bar">
            <div id="countdownText" style="font-size: 11px; font-weight: 600; opacity: 0.7;">05:00</div>
            <div class="search-container" id="searchWrap"><input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onkeyup="applyFilters()"></div>
            <div class="icon-btn" onclick="toggleSearch()">üîç</div>
            <div class="icon-btn btn-l" id="btnLine" onclick="toggleChannelFilter('Line OA', this)">L</div>
            <div class="icon-btn btn-fb" id="btnFb" onclick="toggleChannelFilter('Facebook', this)">FB</div>
            <button class="btn-add" onclick="openAddModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™</button>
            <button onclick="toggleTheme()" class="icon-btn" id="themeBtn">‚òÄ</button>
        </div>
    </div>

    <div class="refresh-bar-container"><div id="refreshBar"></div></div>

    <div class="main-grid">
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div class="leaderboard-grid" id="csLeaderboard"></div>
            <div class="stats-grid">
                <div class="glass-panel stat-card" id="stat-total-all" onclick="setQuickFilter('total-all')"><h3>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><div class="value" id="grandTotalCases">0</div></div>
                <div class="glass-panel stat-card" id="stat-all" onclick="setQuickFilter('all')"><h3>‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</h3><div class="value" id="totalTickets">0</div></div>
                <div class="glass-panel stat-card" id="stat-pending" onclick="setQuickFilter('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')"><h3>üî¥ ‡∏£‡∏≠</h3><div class="value" id="pendingTickets">0</div></div>
                <div class="glass-panel stat-card" id="stat-process" onclick="setQuickFilter('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')"><h3>üü° ‡∏ó‡∏≥</h3><div class="value" id="processTickets">0</div></div>
                <div class="glass-panel stat-card" id="stat-closed" onclick="setQuickFilter('‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™')"><h3>üü¢ ‡∏õ‡∏¥‡∏î</h3><div class="value" id="closedTickets">0</div></div>
            </div>
        </div>
        <div class="glass-panel" style="padding: 10px;"><div id="chart_div"></div></div>
    </div>

    <div class="glass-panel table-wrap">
        <table>
            <thead><tr><th>#</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏∏‡πà‡∏ô</th><th>‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th><th>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th><th>CS</th><th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="addModal" class="modal">
    <div class="modal-content glass-panel">
        <div class="modal-header">
            <h2>üìÇ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà</h2>
            <button onclick="document.getElementById('addModal').style.display='none'" style="background:none; border:none; font-size:24px; color:var(--text); opacity:0.5; cursor:pointer;">√ó</button>
        </div>
        <form id="ticketForm">
            <div class="form-grid">
                <div class="form-group full">
                    <label>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (CS Owner)</label>
                    <select name="owner" id="ownerSelect" required onchange="savePreferredOwner()">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>
                        <option value="Best">Best</option><option value="Friend">Friend</option><option value="Ball">Ball</option><option value="Ohm">Ohm</option>
                    </select>
                </div>
                <div class="form-group full">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                    <input name="customerName" required placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö">
                </div>
                <div class="form-group">
                    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <select name="type" required>
                        <option value="ICE">ICE</option><option value="COFFEE">COFFEE</option><option value="FUME">FUME</option><option value="BLENDER">BLENDER</option><option value="SODA">SODA</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥</option><option value="‡∏õ‡∏±‡πä‡∏°‡∏î‡∏π‡∏î‡∏ô‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ñ‡∏±‡∏á">‡∏õ‡∏±‡πä‡∏°‡∏î‡∏π‡∏î‡∏ô‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ñ‡∏±‡∏á</option><option value="‡∏ï‡∏π‡πâ‡πÅ‡∏ä‡πà‡∏ô‡∏°">‡∏ï‡∏π‡πâ‡πÅ‡∏ä‡πà‡∏ô‡∏°</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <select name="model" required>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                        <option value="12A">12A</option><option value="12B">12B</option><option value="12C">12C</option><option value="15AF">15AF</option><option value="RoG600">RoG600</option><option value="S72C">S72C</option><option value="006C/H">006C/H</option><option value="S9C">S9C</option><option value="07S">07S</option><option value="38F">38F</option><option value="20AF">20AF</option><option value="120F">120F</option><option value="13F-W">13F-W</option><option value="P3B">P3B</option><option value="ProSoda">ProSoda</option><option value="Pro soda max">Pro soda max</option><option value="65S">65S</option><option value="45F">45F</option><option value="ROA4">ROA4</option><option value="U5">U5</option><option value="13F-PS">13F-PS</option><option value="220F">220F</option><option value="700xj">700xj</option><option value="FE 401">FE 401</option><option value="15SA">15SA</option><option value="13F-WB">13F-WB</option><option value="190F">190F</option><option value="20YLR">20YLR</option><option value="Blender">Blender</option><option value="ro-g600">ro-g600</option><option value="M7A">M7A</option><option value="RoA4">RoA4</option><option value="9CN">9CN</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</label>
                    <select name="urgency">
                        <option value="1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å">1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
                        <option value="2.‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á">2.‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                        <option value="3.‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ö" selected>3.‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ö</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label>
                    <select name="channel" required>
                        <option value="Line OA">Line OA</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Shopee">Shopee</option>
                        <option value="‡πÇ‡∏ó‡∏£">‡πÇ‡∏ó‡∏£</option>
                    </select>
                </div>
                <div class="form-group full">
                    <label>‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö</label>
                    <textarea name="issue" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤"></textarea>
                </div>
                <div class="form-group full">
                    <label>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</label>
                    <textarea name="solution" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"></textarea>
                </div>
            </div>
            <button type="submit" id="submitBtn" class="submit-btn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Google Sheets</button>
            <button type="button" class="cancel-btn" onclick="document.getElementById('addModal').style.display='none'">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </form>
    </div>
</div>

<div id="copyToast" class="copy-toast">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß! üìã</div>

<script>
    google.charts.load('current', {'packages':['corechart']});
    const SHEET_ID = '1yP4soDSWwjomPVP3_udd2m3SZlm5j5XVo32tbKGvwdA';
    const SHEET_GID = '816388223';
    const REFRESH_TIME = 300; let countdown = REFRESH_TIME;
    
    let currentQuickFilter = localStorage.getItem('cs_quickFilter') || 'all';
    let currentOwnerFilter = localStorage.getItem('cs_ownerFilter') || null;
    let currentChannelFilter = localStorage.getItem('cs_channelFilter') || 'all';
    let allTickets = [];

    function toggleTheme() {
        const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        document.getElementById('themeBtn').innerText = next === 'dark' ? '‚òæ' : '‚òÄ';
        renderTable(allTickets);
    }

    function startCountdown() {
        setInterval(() => {
            countdown--;
            const min = Math.floor(countdown / 60), sec = countdown % 60;
            const text = document.getElementById('countdownText');
            if(text) text.innerText = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
            const bar = document.getElementById('refreshBar');
            if(bar) bar.style.width = ((REFRESH_TIME - countdown) / REFRESH_TIME) * 100 + "%";
            if (countdown <= 0) location.reload();
        }, 1000);
    }

    function toggleSearch() {
        const wrap = document.getElementById('searchWrap');
        wrap.classList.toggle('expanded');
        if(wrap.classList.contains('expanded')) document.getElementById('searchInput').focus();
    }

    function toggleChannelFilter(c, btn) {
        currentChannelFilter = (currentChannelFilter === c) ? 'all' : c;
        localStorage.setItem('cs_channelFilter', currentChannelFilter);
        updateActiveUI();
        renderTable(allTickets);
    }

    function toggleOwnerFilter(name) {
        currentOwnerFilter = (currentOwnerFilter === name) ? null : name;
        localStorage.setItem('cs_ownerFilter', currentOwnerFilter || "");
        renderTable(allTickets);
    }

    function setQuickFilter(s) {
        currentQuickFilter = s;
        localStorage.setItem('cs_quickFilter', s);
        updateActiveUI();
        renderTable(allTickets);
    }

    function updateActiveUI() {
        const line = document.getElementById('btnLine'); if(line) line.classList.toggle('active', currentChannelFilter === 'Line OA');
        const fb = document.getElementById('btnFb'); if(fb) fb.classList.toggle('active', currentChannelFilter === 'Facebook');
        const statuses = ['total-all', 'all', '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™'];
        const ids = ['stat-total-all', 'stat-all', 'stat-pending', 'stat-process', 'stat-closed'];
        ids.forEach((id, i) => {
            const el = document.getElementById(id);
            if(el) el.classList.toggle('active-status', currentQuickFilter === statuses[i]);
        });
    }

    function applyFilters() { renderTable(allTickets); }

    window.handleGoogleResponse = (json) => {
        allTickets = json.table.rows.map(row => {
            const getV = i => (row.c[i] && (row.c[i].f || row.c[i].v)) ? (row.c[i].f || row.c[i].v) : "-";
            return { ticketId: getV(0), date: getV(1), owner: getV(2), urgent: getV(3), status: getV(4), assignee: getV(5), channel: getV(6), customer: getV(11), solution: getV(13), type: getV(14), model: getV(15), issue: getV(20) };
        }).filter(it => it.ticketId !== "-" && it.ticketId !== "Ticket ID");
        
        allTickets.sort((a, b) => {
            const p = { "1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å": 1, "2.‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á": 2, "3.‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ö": 3 };
            const priorityDiff = (p[a.urgent] || 99) - (p[b.urgent] || 99);
            if (priorityDiff !== 0) return priorityDiff;
            return (a.status.includes("‡∏î‡∏≥") ? 0 : 1) - (b.status.includes("‡∏î‡∏≥") ? 0 : 1);
        });
        
        updateActiveUI();
        renderTable(allTickets);
        startCountdown();
    };

    function renderTable(data) {
        const tbody = document.getElementById("tableBody"); tbody.innerHTML = "";
        let stats = { g: data.length, t:0, p:0, pr:0, c:0 };
        let csStats = { "Best": 0, "Friend": 0, "Ball": 0, "Ohm": 0 };

        allTickets.forEach(r => {
            const isClosed = r.status.includes("‡∏õ‡∏¥‡∏î");
            if(r.status.includes("‡∏£‡∏≠")) stats.p++; else if(r.status.includes("‡∏î‡∏≥")) stats.pr++; else if(isClosed) stats.c++;
            if(!isClosed) { stats.t++; if(csStats.hasOwnProperty(r.owner)) csStats[r.owner]++; }
        });

        const nameClassMap = { "Best": "card-best", "Friend": "card-friend", "Ball": "card-ball", "Ohm": "card-ohm" };
        const lb = document.getElementById('csLeaderboard');
        if(lb) {
            lb.innerHTML = Object.entries(csStats).map(([name, count]) => `
                <div class="person-card ${nameClassMap[name]} ${currentOwnerFilter === name ? 'active-filter' : ''}" onclick="toggleOwnerFilter('${name}')">
                    <span class="person-name">${name}</span><span class="person-count">${count}</span>
                </div>
            `).join('');
        }

        const searchVal = document.getElementById("searchInput").value.toLowerCase();
        let display = data.filter(r => {
            const matchStatus = (currentQuickFilter === 'total-all') ? true : (currentQuickFilter === 'all') ? !r.status.includes("‡∏õ‡∏¥‡∏î") : r.status.includes(currentQuickFilter);
            const matchOwner = currentOwnerFilter ? r.owner === currentOwnerFilter : true;
            const matchChannel = (currentChannelFilter === 'all') ? true : r.channel.includes(currentChannelFilter);
            const matchSearch = searchVal === "" || r.customer.toLowerCase().includes(searchVal) || r.model.toLowerCase().includes(searchVal) || r.ticketId.toLowerCase().includes(searchVal);
            return matchStatus && matchOwner && matchChannel && matchSearch;
        });

        display.forEach((r, i) => {
            tbody.innerHTML += `<tr>
                <td style="opacity:0.4">${i+1}</td><td style="font-weight:600; color:var(--primary)">${r.ticketId}</td><td>${r.date}</td><td>${r.channel}</td>
                <td><span class="copyable-name" onclick="copyCustomerName('${r.customer}')">${r.customer} üìã</span></td>
                <td><b>${r.model}</b><br><small style="opacity:0.7">${r.type}</small></td>
                <td>${r.issue}</td><td style="color:#27ae60">${r.solution}</td><td style="font-weight:600">${r.owner}</td>
                <td><span class="badge ${r.urgent.includes("1")?'u-vhigh':r.urgent.includes("2")?'u-medium':'u-low'}">${r.urgent}</span></td>
                <td><span class="badge ${r.status.includes("‡∏õ‡∏¥‡∏î")?'status-closed':r.status.includes("‡∏î‡∏≥")?'status-process':'status-pending'}">${r.status}</span></td>
                <td>${r.assignee}</td>
            </tr>`;
        });
        document.getElementById("grandTotalCases").innerText = stats.g; 
        document.getElementById("totalTickets").innerText = stats.t; 
        document.getElementById("pendingTickets").innerText = stats.p; 
        document.getElementById("processTickets").innerText = stats.pr; 
        document.getElementById("closedTickets").innerText = stats.c;
        drawChart(allTickets);
    }

    function drawChart(data) {
        const modelCounts = {};
        data.forEach(r => { if(r.model !== "-" && r.model !== "") modelCounts[r.model] = (modelCounts[r.model] || 0) + 1; });
        const sortedModels = Object.entries(modelCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
        const chartData = [['Model', 'Count']];
        sortedModels.forEach(([m, c]) => chartData.push([m, c]));
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const options = {
            title: '10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏Å‡∏ö‡πà‡∏≠‡∏¢', pieHole: 0.4, backgroundColor: 'transparent',
            legend: { textStyle: { color: isDark ? '#fff' : '#000', fontSize: 10 } },
            titleTextStyle: { color: isDark ? '#fff' : '#000', fontSize: 12, bold: true },
            chartArea: { width: '90%', height: '80%' },
            colors: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8AC926', '#1982C4', '#6A4C93', '#FF595E']
        };
        const chart = new google.visualization.PieChart(document.getElementById('chart_div'));
        if(chart) chart.draw(google.visualization.arrayToDataTable(chartData), options);
    }

    const script = document.createElement('script');
    script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:handleGoogleResponse&gid=${SHEET_GID}`;
    document.body.appendChild(script);

    function copyCustomerName(name) {
        navigator.clipboard.writeText(name).then(() => {
            const toast = document.getElementById('copyToast');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        });
    }

    function openAddModal() {
        document.getElementById('ticketForm').reset();
        const pref = localStorage.getItem('preferredOwner');
        if(pref) document.getElementById('ownerSelect').value = pref;
        document.getElementById('addModal').style.display = 'block';
    }

    function savePreferredOwner() { localStorage.setItem('preferredOwner', document.getElementById('ownerSelect').value); }

    document.getElementById('ticketForm').onsubmit = function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn'); btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."; btn.disabled = true;
        fetch("https://script.google.com/macros/s/AKfycbzDRJpLUw51hZi3WI6Su7_LgeXz0GG-bK4CtfGygkmbfne2dMdtbVAVjD0NDmuEaL8v/exec", { method: 'POST', body: new URLSearchParams(new FormData(this)), mode: 'no-cors' }).then(() => location.reload());
    };
</script>
</body>
</html>
